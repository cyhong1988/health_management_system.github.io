<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STAY HEALTHY! Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        input[type="date"], input[type="number"], select, input[type="text"] {
            height: 52px !important; border-radius: 14px !important; border: 1px solid #e2e8f0 !important;
            padding: 0 16px !important; background-color: #f8fafc !important; font-size: 16px !important;
        }
        .chart-container { position: relative; height: 200px; width: 100%; }
        .tab-title { border-left: 5px solid; padding-left: 12px; margin-bottom: 15px; font-weight: 800; font-size: 13px; display: flex; align-items: center; justify-content: space-between; }
        .range-btn {
            background-color: white; color: #64748b; border: 1px solid #e2e8f0;
            padding: 8px 14px; border-radius: 9999px; font-size: 12px; font-weight: 600; cursor: pointer;
            transition: all 0.2s; white-space: nowrap;
        }
        .range-btn.active { background-color: #2563eb; color: white; border-color: #2563eb; }
        #loginPage { display: flex; background-color: #0f172a; flex-direction: column; align-items: center; justify-content: flex-start; min-height: 100vh; }
        #mainApp { display: none; }
        .btn-action { height: 50px; border-radius: 16px; font-weight: 800; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; font-size: 14px; }
        .user-card { 
            display: flex; align-items: center; justify-content: space-between; 
            background: #f8fafc; padding: 16px 20px; border-radius: 20px; 
            margin-bottom: 12px; border: 1px solid #e2e8f0; transition: 0.2s;
        }
        .user-card:hover { border-color: #3b82f6; background: white; }
        .delete-btn { color: #94a3b8; transition: 0.2s; padding: 8px; cursor: pointer; }
        .delete-btn:hover { color: #ef4444; transform: scale(1.1); }
        .history-item { border-bottom: 1px solid #f1f5f9; padding: 10px 0; display: flex; justify-content: space-between; align-items: center; }
        .history-item:last-child { border-bottom: none; }
        .update-h-btn { font-size: 10px; background: #f1f5f9; color: #64748b; padding: 2px 8px; border-radius: 6px; cursor: pointer; transition: 0.2s; }
        .update-h-btn:hover { background: #e2e8f0; color: #1e293b; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">

    <div id="loginPage" class="p-6 pt-20 flex-grow">
        <div class="max-w-md w-full bg-white rounded-[40px] p-8 shadow-2xl text-center">
            <h1 class="text-3xl font-black italic text-slate-900 mb-2">STAY HEALTHY!</h1>
            <p class="text-slate-400 text-xs mb-8 font-bold uppercase tracking-widest">健康數據管理系統</p>
            <div class="space-y-4 mb-10">
                <input type="text" id="userNameInput" placeholder="輸入使用者名稱..." class="w-full text-lg font-bold">
                <button onclick="login()" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl shadow-lg hover:bg-blue-700 transition">登入 或 建立新帳號</button>
            </div>
            <div id="userListContainer" class="text-left border-t border-slate-100 pt-8 hidden">
                <h3 class="text-xs font-black text-slate-400 mb-4 uppercase tracking-widest px-2">快速登入 / 管理</h3>
                <div id="userList" class="max-h-[300px] overflow-y-auto pr-2"></div>
            </div>
        </div>
    </div>

    <div id="mainApp" class="flex-col flex-grow">
<nav class="bg-slate-900 text-white p-4 sticky top-0 z-50 shadow-lg">
    <div class="container mx-auto flex justify-between items-center">
        <div class="flex flex-col cursor-pointer" onclick="logout()">
            <h1 class="text-xl sm:text-2xl font-black italic leading-none tracking-tighter">STAY HEALTHY!</h1>
            <span class="text-[10px] text-blue-400 font-bold uppercase tracking-widest mt-1">Cloud Sync Pro</span>
        </div>

        <div class="flex items-center gap-3">
            <div id="userBadge" class="bg-slate-800 border border-slate-700 px-3 py-1.5 rounded-full flex items-center gap-2">
                <div class="w-6 h-6 bg-blue-600 rounded-full flex items-center justify-center text-[10px]">
                    <i class="fas fa-user"></i>
                </div>
                <div class="flex flex-col">
                    <span class="text-[10px] text-slate-400 leading-none">使用者</span>
                    <span id="displayUserName" class="text-sm font-black text-white leading-tight">未登入</span>
                </div>
            </div>
            
            <button onclick="logout()" class="h-10 w-10 flex items-center justify-center bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white rounded-xl transition-all duration-300">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
    </div>
</nav>

        <main class="container mx-auto p-4 lg:p-6 grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-4 space-y-8">
                <div class="bg-white p-8 rounded-[32px] shadow-sm border border-slate-100">
                    <h2 class="font-black mb-6 text-slate-800 flex items-center text-lg"><i class="fas fa-plus-circle mr-3 text-blue-500"></i>數據輸入</h2>
                    <form class="space-y-4" onsubmit="return false;">
                        <div class="grid grid-cols-1 gap-4">
                            <input type="date" id="dateInput" required class="w-full text-base font-bold">
                            <input type="number" id="heightInput" step="0.1" placeholder="身高 cm" class="w-full text-base font-bold !bg-blue-50/50">
                        </div>
                        <div class="grid grid-cols-3 gap-3">
                            <input type="number" id="weightInput" step="0.1" placeholder="體重" class="text-center font-bold">
                            <input type="number" id="fatInput" step="0.1" placeholder="體脂" class="text-center font-bold">
                            <input type="number" id="vFatInput" step="0.5" placeholder="內臟" class="text-center font-bold">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 pt-2">
                            <button type="button" onclick="handleSave('none')" class="btn-action bg-blue-600 text-white shadow-md">
                                <i class="fas fa-save"></i> 僅儲存
                            </button>
                            <button type="button" onclick="handleSave('month')" class="btn-action bg-[#06C755] text-white shadow-md">
                                <i class="fab fa-line"></i> 儲存並分享
                            </button>
                        </div>
                    </form>
                </div>

                <div class="bg-white p-6 rounded-[32px] shadow-sm border border-slate-100">
                    <h3 class="text-sm font-black text-slate-800 mb-4 flex items-center">
                        <i class="fas fa-history mr-2 text-blue-500"></i> 最近 10 筆紀錄
                    </h3>
                    <div id="recentHistoryList" class="text-sm"></div>
                </div>
                
                <div class="bg-white p-6 rounded-[32px] shadow-sm border border-slate-100">
                    <h3 class="text-xs font-bold text-slate-400 mb-3 uppercase">批次匯入</h3>
                    <textarea id="importArea" rows="2" class="w-full p-4 bg-slate-50 rounded-2xl text-xs border-none" placeholder="貼上 LINE 格式數據..."></textarea>
                    <button onclick="processBatchImport()" class="w-full mt-2 py-4 bg-slate-900 text-white rounded-xl text-sm font-black">解析並匯入數據</button>
                </div>
            </div>

            <div class="lg:col-span-8 space-y-6">
                <div class="bg-white p-6 rounded-[32px] border border-slate-100 shadow-sm space-y-4">
                    <div class="flex flex-wrap items-center gap-2">
                        <select id="filterYear" onchange="setRange('selected_month')" class="!h-10 !px-3 !text-sm !bg-slate-100 !border-none !rounded-xl font-bold"></select>
                        <select id="filterMonth" onchange="setRange('selected_month')" class="!h-10 !px-3 !text-sm !bg-slate-100 !border-none !rounded-xl font-bold"></select>
                        <div class="h-px w-full md:w-px md:h-6 bg-slate-200 mx-1"></div>
                        <div class="flex flex-wrap items-center gap-2">
                            <button onclick="setRange('selected_month')" id="btn-selected_month" class="range-btn active">指定月</button>
                            <button onclick="setRange('3months')" id="btn-3months" class="range-btn">近3月</button>
                            <button onclick="setRange('6months')" id="btn-6months" class="range-btn">近6月</button>
                            <button onclick="setRange('year')" id="btn-year" class="range-btn">近1年</button>
                            <button onclick="setRange('all')" id="btn-all" class="range-btn">全部</button>
                        </div>
                    </div>
                    <div class="pt-4 border-t border-slate-50 flex flex-col sm:flex-row gap-4">
                        <button onclick="shareDetailedReport('month')" class="flex-1 h-14 bg-[#06C755] text-white rounded-2xl text-base font-black shadow-lg flex items-center justify-center gap-2">
                            <i class="fab fa-line text-xl"></i> 分享目前月份報告
                        </button>
                        <button onclick="shareDetailedReport('year')" class="flex-1 h-14 bg-orange-600 text-white rounded-2xl text-base font-black shadow-lg flex items-center justify-center gap-2">
                            <i class="fas fa-calendar-alt text-lg"></i> 分享目前年度報告
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pb-10">
                    <div class="bg-white p-6 rounded-[35px] shadow-sm border border-slate-100">
                        <div class="tab-title border-blue-500 text-blue-600"><span>體重 TREND</span></div>
                        <div class="chart-container"><canvas id="weightChart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-[35px] shadow-sm border border-indigo-500">
                        <div class="tab-title border-indigo-500 text-indigo-600">
                            <span>BMI TREND</span>
                            <button onclick="updateHeightPrompt()" class="update-h-btn"><i class="fas fa-edit mr-1"></i>更新身高</button>
                        </div>
                        <div class="chart-container"><canvas id="bmiChart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-[35px] shadow-sm border border-emerald-500">
                        <div class="tab-title border-emerald-500 text-emerald-600"><span>體脂肪 TREND (%)</span></div>
                        <div class="chart-container"><canvas id="fatChart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-[35px] shadow-sm border border-orange-500">
                        <div class="tab-title border-orange-500 text-orange-600"><span>內臟脂肪 TREND</span></div>
                        <div class="chart-container"><canvas id="vFatChart"></canvas></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <footer id="commonFooter" class="bg-slate-900 text-slate-500 py-8">
        <div class="container mx-auto px-6 text-center">
            <p class="text-sm font-bold tracking-widest uppercase mb-2">© 2025 Stay Healthy! System</p>
            <p class="text-xs opacity-70">All Rights Reserved. Designed by <span class="text-blue-400 font-black">Alex Hong</span></p>
        </div>
    </footer>

    <script>
        let currentUserName = "";
        let healthData = [];
        let charts = {};
        let currentRange = 'selected_month';

// 替換您的 GAS URL
const GAS_URL = "https://script.google.com/macros/s/AKfycbyzD-jRK6VdvDpci-Y8Bl-tMynNbj7tZY1JlLF5TZ1Zt5rDqegcfUs2HC73M_5WkkUk/exec";

async function login(n) {
    currentUserName = n || document.getElementById('userNameInput').value.trim();
    if (!currentUserName) return alert("請輸入名稱");
    
    let list = JSON.parse(localStorage.getItem('health_os_user_list')) || [];
    if (!list.includes(currentUserName)) list.push(currentUserName);
    localStorage.setItem('health_os_user_list', JSON.stringify(list));
    
    try {
        const response = await fetch(`${GAS_URL}?userName=${encodeURIComponent(currentUserName)}`);
        let rawData = await response.json();
        
        // 核心修正：確保從雲端抓下來的日期格式為 YYYY-MM-DD
        healthData = rawData.map(item => ({
            ...item,
            date: item.date.includes('T') ? item.date.split('T')[0] : item.date
        }));
        
    } catch (e) {
        console.log("雲端無資料，載入本地備份");
        healthData = JSON.parse(localStorage.getItem(`health_os_data_${currentUserName}`)) || [];
    }

    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('mainApp').style.display = 'flex';
    document.getElementById('displayUserName').innerText = currentUserName; // 配合剛才的 Navbar 修改
    initApp();
}

// 修改後的儲存函數：存入 LocalStorage 同時上傳至 Google Sheet
async function saveAndRefresh() {
    // 1. 先存在本地（防斷網）
    localStorage.setItem(`health_os_data_${currentUserName}`, JSON.stringify(healthData));
    
    // 2. 上傳到雲端
    try {
        await fetch(GAS_URL, {
            method: 'POST',
            body: JSON.stringify({
                userName: currentUserName,
                data: healthData
            })
        });
        console.log("雲端同步成功");
    } catch (e) {
        alert("雲端同步失敗，資料目前僅存於此裝置");
    }
    
    updateCharts();
    updateHistoryList();
}
        
        function renderUserList() {
            const list = JSON.parse(localStorage.getItem('health_os_user_list')) || [];
            const container = document.getElementById('userListContainer');
            const listDiv = document.getElementById('userList');
            if (list.length > 0) {
                container.classList.remove('hidden');
                listDiv.innerHTML = list.map(u => `
                    <div class="user-card">
                        <div class="flex-1 cursor-pointer font-bold text-slate-700" onclick="login('${u}')"><i class="fas fa-user-circle mr-2 text-blue-500"></i> ${u}</div>
                        <button onclick="deleteUser('${u}')" class="delete-btn"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `).join('');
            } else { container.classList.add('hidden'); }
        }

        function deleteUser(userName) {
            if (confirm(`確定刪除「${userName}」及所有數據？`)) {
                let list = (JSON.parse(localStorage.getItem('health_os_user_list')) || []).filter(u => u !== userName);
                localStorage.setItem('health_os_user_list', JSON.stringify(list));
                localStorage.removeItem(`health_os_data_${userName}`);
                localStorage.removeItem(`health_os_height_${userName}`);
                renderUserList();
            }
        }


        function logout() { location.reload(); }

        // --- 核心修正點：日期初始化函數 ---
        function initApp() {
            // 獲取當前本地時間 YYYY-MM-DD
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const formattedDate = `${year}-${month}-${day}`;
            
            document.getElementById('dateInput').value = formattedDate;
            
            const savedHeight = localStorage.getItem(`health_os_height_${currentUserName}`);
            document.getElementById('heightInput').value = savedHeight || "";
            updateSelectors();
            initCharts();
            updateHistoryList();
        }

        window.updateHeightPrompt = function() {
            const currentH = localStorage.getItem(`health_os_height_${currentUserName}`) || "";
            const newHeight = prompt("請輸入您的身高 (cm):", currentH);
            if (newHeight !== null && !isNaN(newHeight) && newHeight > 0) {
                localStorage.setItem(`health_os_height_${currentUserName}`, newHeight);
                document.getElementById('heightInput').value = newHeight;
                updateCharts();
                alert("身高已更新，BMI 圖表已重新計算。");
            }
        };

        function updateHistoryList() {
            const listDiv = document.getElementById('recentHistoryList');
            const sorted = [...healthData].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10);
            if (sorted.length === 0) {
                listDiv.innerHTML = `<p class="text-slate-400 italic py-4">尚無數據...</p>`;
                return;
            }
            listDiv.innerHTML = sorted.map(item => `
                <div class="history-item">
                    <div>
                        <span class="font-bold text-slate-700 mr-2">${item.date.slice(5)}</span>
                        <span class="text-slate-500">${item.weight}kg / ${item.fat}% / V:${item.vFat}</span>
                    </div>
                    <button onclick="deleteRecord('${item.date}')" class="delete-btn text-xs"><i class="fas fa-times-circle"></i></button>
                </div>
            `).join('');
        }

        window.deleteRecord = function(date) {
            if (confirm(`確定刪除 ${date} 的紀錄？`)) {
                healthData = healthData.filter(d => d.date !== date);
                saveAndRefresh();
            }
        };

        function updateSelectors() {
            const now = new Date();
            const yearSelect = document.getElementById('filterYear');
            const monthSelect = document.getElementById('filterMonth');
            yearSelect.innerHTML = "";
            for(let i=0; i<3; i++) {
                let y = (now.getFullYear() - i).toString();
                yearSelect.innerHTML += `<option value="${y}">${y}年</option>`;
            }
            monthSelect.innerHTML = Array.from({length: 12}, (_, i) => {
                let m = (i + 1).toString().padStart(2, '0');
                return `<option value="${m}">${i+1}月</option>`;
            }).join('');
            monthSelect.value = (now.getMonth() + 1).toString().padStart(2, '0');
        }

function generateShareText(title, dataArr) {
    let msg = `【${currentUserName} - ${title}】\n\n`;
    dataArr.forEach((item, index) => {
        // 確保日期只取前 10 位 (YYYY-MM-DD) 並轉換斜線
        const pureDate = item.date.includes('T') ? item.date.split('T')[0] : item.date;
        const d = pureDate.split('-');
        
        // 輸出格式：11/20
        msg += `${d[1]}/${d[2]}\n體重${item.weight} / 體脂${item.fat}% / 內臟${item.vFat}\n\n`;
    });
    return msg.trim();
}

        window.handleSave = function(shareType) {
            const date = document.getElementById('dateInput').value;
            const weight = parseFloat(document.getElementById('weightInput').value);
            const fat = parseFloat(document.getElementById('fatInput').value) || 0;
            const vFat = parseFloat(document.getElementById('vFatInput').value) || 0;
            const h = document.getElementById('heightInput').value;
            if (!weight || isNaN(weight)) return alert("請輸入體重數據");
            if (h) localStorage.setItem(`health_os_height_${currentUserName}`, h);
            
            const entry = { date, weight, fat, vFat };
            const idx = healthData.findIndex(d => d.date === date);
            if (idx > -1) healthData[idx] = entry; else healthData.push(entry);
            
            healthData.sort((a, b) => new Date(a.date) - new Date(b.date));
            saveAndRefresh();

            if (shareType === 'month') {
                const parts = date.split('-');
                const yyyy = parts[0];
                const mm = parts[1];
                let targetData = healthData.filter(d => d.date.startsWith(`${yyyy}-${mm}`));
                targetData.sort((a, b) => new Date(a.date) - new Date(b.date));
                const msg = generateShareText(`${yyyy}/${mm} 紀錄`, targetData);
                window.location.href = `https://line.me/R/msg/text/?${encodeURIComponent(msg)}`;
            } else if (shareType === 'none') {
                alert("儲存成功");
            }
        };

        window.shareDetailedReport = function(type) {
            const year = document.getElementById('filterYear').value;
            const month = document.getElementById('filterMonth').value;
            let targetData = healthData.filter(d => type === 'month' ? d.date.startsWith(`${year}-${month}`) : d.date.startsWith(year));
            if (targetData.length === 0) return alert("此時段沒有數據");
            targetData.sort((a, b) => new Date(a.date) - new Date(b.date));
            const msg = generateShareText(type === 'month' ? `${year}/${month} 紀錄` : `${year}年度紀錄`, targetData);
            window.location.href = `https://line.me/R/msg/text/?${encodeURIComponent(msg)}`;
        };

        function initCharts() {
            const cfg = (l, c) => ({
                type: 'line',
                data: { labels: [], datasets: [{ label: l, data: [], borderColor: c, backgroundColor: c+'15', tension: 0.4, fill: true, pointRadius: 3 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
            charts.weight = new Chart(document.getElementById('weightChart'), cfg('體重', '#3b82f6'));
            charts.bmi = new Chart(document.getElementById('bmiChart'), cfg('BMI', '#6366f1'));
            charts.fat = new Chart(document.getElementById('fatChart'), cfg('體脂', '#10b981'));
            charts.vFat = new Chart(document.getElementById('vFatChart'), cfg('內臟', '#f97316'));
            updateCharts();
        }

        function updateCharts() {
            const y = document.getElementById('filterYear').value;
            const m = document.getElementById('filterMonth').value;
            const h = parseFloat(localStorage.getItem(`health_os_height_${currentUserName}`)) || 0;
            const now = new Date();
            let filtered = [];
            if (currentRange === 'selected_month') {
                filtered = healthData.filter(d => d.date.startsWith(`${y}-${m}`));
            } else {
                let cutoff = new Date();
                if (currentRange === '3months') cutoff.setMonth(now.getMonth() - 3);
                else if (currentRange === '6months') cutoff.setMonth(now.getMonth() - 6);
                else if (currentRange === 'year') cutoff.setFullYear(now.getFullYear() - 1);
                else if (currentRange === 'all') cutoff = new Date(0);
                filtered = healthData.filter(d => new Date(d.date) >= cutoff);
            }
            const labels = filtered.map(d => d.date.slice(5).replace('-', '/'));
            charts.weight.data.labels = labels; charts.weight.data.datasets[0].data = filtered.map(d => d.weight); charts.weight.update();
            charts.bmi.data.labels = labels; charts.bmi.data.datasets[0].data = filtered.map(d => h ? (d.weight / ((h/100)**2)).toFixed(1) : 0); charts.bmi.update();
            charts.fat.data.labels = labels; charts.fat.data.datasets[0].data = filtered.map(d => d.fat); charts.fat.update();
            charts.vFat.data.labels = labels; charts.vFat.data.datasets[0].data = filtered.map(d => d.vFat); charts.vFat.update();
        }

        window.setRange = (r) => { currentRange = r; document.querySelectorAll('.range-btn').forEach(b => b.classList.toggle('active', b.id === `btn-${r}`)); updateCharts(); };

        window.processBatchImport = function() {
            const text = document.getElementById('importArea').value;
            if (!text.trim()) return alert("請輸入內容");
            const yearMatch = text.match(/20\d{2}/);
            let defaultYear = yearMatch ? yearMatch[0] : document.getElementById('filterYear').value;
            const lines = text.split('\n').map(l => l.trim()).filter(l => l);
            let importedCount = 0;
            for (let i = 0; i < lines.length; i++) {
                const dateMatch = lines[i].match(/^(\d{1,2})\/(\d{1,2})$/);
                if (dateMatch && i + 1 < lines.length) {
                    const fullDate = `${defaultYear}-${dateMatch[1].padStart(2, '0')}-${dateMatch[2].padStart(2, '0')}`;
                    const getVal = (label) => {
                        const m = lines[i+1].match(new RegExp(`${label}\\s*[:：]?\\s*([\\d.]+)`));
                        return m ? parseFloat(m[1]) : 0;
                    };
                    const entry = { date: fullDate, weight: getVal('體重'), fat: getVal('體脂'), vFat: getVal('內臟') };
                    if (entry.weight > 0) {
                        const idx = healthData.findIndex(d => d.date === entry.date);
                        if (idx > -1) healthData[idx] = entry; else healthData.push(entry);
                        importedCount++; i++;
                    }
                }
            }
            if (importedCount > 0) {
                healthData.sort((a, b) => new Date(a.date) - new Date(b.date));
                saveAndRefresh();
                alert(`成功匯入 ${importedCount} 筆。`);
                document.getElementById('importArea').value = "";
            } else { alert("格式不符。"); }
        };

        renderUserList();
    </script>
</body>
</html>
